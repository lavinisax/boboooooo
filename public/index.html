<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BooomBob! - Ultimate Edition</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #111827;
            color: white;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            user-select: none;
            width: 100vw;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: #93C5FD;
            overflow: hidden;
            transition: background-color 1s;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* --- ARAY√úZ (UI) --- */
        .overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
            background-color: rgba(0, 0, 0, 0.9);
            transition: opacity 0.3s;
            overflow: hidden;
        }

        /* YENƒ∞ Bƒ∞LDƒ∞Rƒ∞M KUTUSU */
        #custom-notification {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #1F2937;
            border: 4px solid #EF4444;
            color: white;
            padding: 20px 40px;
            border-radius: 20px;
            z-index: 100;
            text-align: center;
            font-family: 'Impact', sans-serif;
            font-size: 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        #custom-notification.active {
            transform: translate(-50%, -50%) scale(1);
        }

        /* ARKA PLAN EFEKTLERƒ∞ */
        .floating-item, .floating-heart {
            position: absolute;
            pointer-events: none;
            z-index: 1; 
            top: -100px; 
            animation-name: fallDown;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .floating-item { opacity: 0.6; } 
        .floating-heart { color: #F43F5E; opacity: 0.8; text-shadow: 0 0 10px red; font-weight: bold; }

        @keyframes fallDown {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
        }

        .menu-content {
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            width: 100%;
        }

        h1 {
            font-family: 'Comic Sans MS', 'Impact', sans-serif;
            font-size: 6rem;
            font-weight: 400;
            color: #ff0055;
            text-shadow: 2px 2px 0px #FACC15, 4px 4px 0px #000;
            text-align: center;
            line-height: 1;
            margin-bottom: 1rem;
            transform: rotate(-3deg);
            animation: shakeTitle 3s infinite ease-in-out;
        }
        
        @keyframes shakeTitle {
            0%, 100% { transform: rotate(-3deg) scale(1); }
            50% { transform: rotate(3deg) scale(1.05); }
        }

        .subtitle {
            font-size: 1.5rem;
            color: #FACC15;
            background: black;
            padding: 0.5rem 1rem;
            transform: rotate(2deg);
            margin-bottom: 30px;
            font-weight: normal;
            font-family: monospace;
            letter-spacing: 2px;
        }

        /* Butonlar */
        .menu-row {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        button {
            padding: 1rem 2rem;
            font-weight: 500;
            border-radius: 1rem;
            font-size: 1.2rem;
            border: 2px solid black;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 4px 4px 0px black;
            text-transform: uppercase;
            font-family: 'Impact', sans-serif;
            letter-spacing: 1px;
        }
        button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px black; }
        
        .btn-start { background-color: #4ADE80; color: black; font-size: 2rem; padding: 1.2rem 4rem; } 
        .btn-shop { background-color: #60A5FA; color: black; }
        .btn-inventory { background-color: #A78BFA; color: black; }
        .btn-levels { background-color: #FBBF24; color: black; }
        .btn-settings { background-color: #9CA3AF; color: black; font-size: 1rem; padding: 0.8rem 1.5rem; display: block; margin: 10px auto; }
        
        .btn-bug, .btn-sugg { 
            color: white; font-size: 1rem; padding: 0.8rem 2rem; margin-top: 10px; width: auto; min-width: 220px; 
        }
        .btn-bug { background-color: #EF4444; }
        .btn-sugg { background-color: #3B82F6; }
        
        .btn-back { background-color: #F87171; color: white; margin-top: 20px; }

        /* Oyun ƒ∞√ßi Ayarlar Butonu */
        #btn-ingame-settings {
            position: absolute; top: 1rem; right: 1rem;
            background: #374151; color: white; border: 2px solid white;
            font-size: 1.5rem; padding: 0.5rem; border-radius: 10px;
            cursor: pointer; z-index: 60; display: none; box-shadow: none;
        }

        /* Pedallar */
        #pedals-container {
            position: absolute; bottom: 2rem; left: 2rem;
            display: none; gap: 20px; z-index: 40;
        }
        .pedal {
            width: 60px; height: 100px; background: #374151;
            border: 4px solid #1F2937; border-radius: 10px;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 10px; color: rgba(255,255,255,0.5); font-weight: bold; font-family: sans-serif;
            transition: transform 0.1s, background-color 0.1s; box-shadow: 5px 5px 10px rgba(0,0,0,0.5);
        }
        .pedal.brake { background: linear-gradient(to bottom, #4B5563, #EF4444); }
        .pedal.gas { background: linear-gradient(to bottom, #4B5563, #4ADE80); height: 120px; }
        .pedal.pressed { transform: scale(0.95) rotateX(10deg); filter: brightness(1.2); box-shadow: 2px 2px 5px rgba(0,0,0,0.5); }

        /* Kaydƒ±rƒ±labilir Alanlar */
        .scroll-area {
            width: 80%; height: 60%; overflow-y: auto;
            background: rgba(255,255,255,0.1); border-radius: 20px; padding: 20px;
            text-align: center; border: 2px solid #4B5563;
        }
        
        .screen-title { font-family: 'Impact'; font-size: 3rem; color: #60A5FA; text-shadow: 3px 3px 0 black; margin: 0 0 10px 0; font-weight: normal; }

        .shop-section-title {
            width: 100%; text-align: left; font-size: 1.5rem; color: #FACC15;
            border-bottom: 2px solid #FACC15; margin-top: 30px; margin-bottom: 15px;
            padding-bottom: 5px; font-weight: 500; font-family: 'Impact', sans-serif;
        }

        /* Shop Grid */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .shop-item {
            background: #374151; padding: 10px; border: 2px solid #9CA3AF;
            border-radius: 10px; text-align: center; cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between;
        }
        .shop-item:hover { transform: scale(1.05); background: #4B5563; border-color: #FACC15; }
        .shop-item.owned { display: none !important; } 
        .shop-item.equipped { border-color: #FACC15; background: #374151; opacity: 1; box-shadow: 0 0 10px #FACC15; }
        
        .item-icon { font-size: 2.5rem; margin-bottom: 5px; }
        .item-name { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: white; }
        .item-price { color: #FACC15; font-size: 0.9rem; font-weight: bold; }
        .item-status { font-size: 0.8rem; color: #4ADE80; font-weight: bold; margin-top: 5px; }

        /* Level Se√ßimi */
        .level-btn {
            width: 100%; margin-bottom: 15px; background: #374151; color: white;
            text-align: left; padding: 20px; display: flex; justify-content: space-between;
            font-size: 1.3rem; align-items: center; border: 2px solid transparent; font-weight: 500;
        }
        .level-btn:hover { background: #4B5563; border-color: #FACC15; }
        .level-info { font-size: 1rem; opacity: 0.8; }

        /* Ayarlar */
        .settings-section { margin-bottom: 30px; text-align: center; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .lang-container { display: flex; justify-content: center; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .lang-btn { margin: 0 10px; background: #374151; color: white; border: 2px solid #9CA3AF; font-weight: normal; min-width: 100px; }
        .lang-btn.active { background: #4ADE80; color: black; border-color: white; }
        
        #suggestions-box { display: none; margin-top: 10px; width: 100%; }
        .suggestion-toggle-btn {
            background: none; border: none; color: #FACC15; text-decoration: underline; 
            font-size: 0.9rem; cursor: pointer; box-shadow: none; font-family: sans-serif; text-transform: none;
        }
        textarea { width: 80%; height: 80px; border-radius: 10px; padding: 10px; margin-top: 10px; resize: none; background: #eee; font-family: sans-serif; font-size: 1rem; color:black; }

        /* OYUN ƒ∞√áƒ∞ G√ñSTERGELER */
        #gameover-screen, #win-screen, #ingame-settings-screen { display: none; }
        #win-screen { background-color: rgba(6, 95, 70, 0.95); }
        #gameover-screen { background-color: rgba(127, 29, 29, 0.95); }
        #gameover-screen h2, #win-screen h2 { font-size: 5rem; font-weight: 900; margin-bottom: 0.5rem; text-shadow: 5px 5px 0 black; font-family: 'Comic Sans MS', sans-serif; }

        #score-board {
            position: absolute; top: 2rem; left: 2rem;
            background-color: rgba(0, 0, 0, 0.7); color: #FACC15;
            padding: 0.5rem 1rem; border-radius: 0.5rem;
            font-size: 1.5rem; font-family: 'Impact', sans-serif;
            border: 2px solid white; display: none; z-index: 40; transform: skew(-10deg);
        }
        #level-indicator {
            position: absolute; top: 5.5rem; left: 2rem;
            background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 0.3rem 1rem; border-radius: 0.5rem;
            font-size: 1rem; font-family: monospace; font-weight: bold;
            border: 2px solid #FACC15; display: none; z-index: 40; transform: skew(-10deg);
        }
        #coin-counter {
            position: absolute; top: 2rem; right: 5rem;
            background-color: rgba(255, 215, 0, 0.9); color: black;
            padding: 0.5rem 1rem; border-radius: 0.5rem;
            font-size: 1.5rem; font-weight: bold;
            border: 3px solid black; z-index: 40;
            display: none; align-items: center; gap: 10px;
            box-shadow: 5px 5px 0px rgba(0,0,0,0.5);
        }

        #speedometer {
            position: absolute; bottom: 2rem; right: 2rem;
            width: 160px;
            background: linear-gradient(180deg, #1F2937 0%, #111827 100%);
            border: 4px solid #4B5563; border-radius: 1rem;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.5); z-index: 40;
        }
        #speed-bar-container { width: 90%; height: 8px; background: #374151; border-radius: 4px; margin-bottom: 5px; overflow: hidden; }
        #speed-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #4ADE80, #FACC15, #EF4444); transition: width 0.1s linear; }
        #boost-bar-container { width: 90%; height: 8px; background: #374151; border-radius: 4px; margin-bottom: 5px; overflow: hidden; }
        #boost-bar { width: 100%; height: 100%; background: #FACC15; transition: width 0.1s linear; }
        #boost-label { font-size: 0.7rem; color: #FACC15; font-weight: bold; margin-bottom: 2px; }
        #speed-value { font-family: monospace; font-size: 2rem; font-weight: 900; color: #EF4444; line-height: 1; }
        #speed-unit { font-size: 0.7rem; color: #9CA3AF; font-weight: bold; margin-top: -5px; }

        /* Mesajlar */
        #panic-message, #broke-message, #dumb-message {
            position: absolute; top: 20%; right: -500px;
            background-color: #FEF08A; color: #DC2626; border: 4px solid #EF4444;
            padding: 1.5rem; font-family: 'Comic Sans MS', sans-serif; font-weight: 900;
            font-size: 2rem; text-align: center; transform: rotate(-10deg);
            box-shadow: 10px 10px 0px rgba(0,0,0,0.3); transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 45;
        }
        #panic-message.active { right: 50px; }
        
        #broke-message { top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); transition: transform 0.2s; right: auto; pointer-events: none; z-index: 100;}
        #broke-message.active { transform: translate(-50%, -50%) scale(1) rotate(-10deg); }

        #dumb-message { top: 40%; right: 50%; transform: translate(50%, -50%) rotate(5deg); display:none; z-index: 100; }
        #dumb-message.active { display: block; right: 50%; }

        #level3-message {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: black; color: #FACC15; border: 5px solid #FACC15; padding: 2rem;
            font-family: 'Impact', sans-serif; font-size: 3rem; text-align: center; z-index: 60;
            transition: transform 0.5s; pointer-events: none;
        }
        #level3-message.active { transform: translate(-50%, -50%) scale(1) rotate(-5deg); }

        #tutorial-text {
            position: absolute; bottom: 30%; left: 50%; transform: translateX(-50%);
            font-size: 1.5rem; color: white; font-weight: bold; text-shadow: 2px 2px 4px black;
            background: rgba(0,0,0,0.7); padding: 15px 25px; border-radius: 15px; border: 2px solid white;
            display: none; z-index: 45; text-align: center;
        }

        #panic-overlay { position: absolute; inset: 0; background: rgba(255,0,0,0); pointer-events: none; transition: background 0.2s; z-index: 35; }
        #panic-overlay.active { background: rgba(255,0,0,0.3); }

        .credits {
            position: absolute; bottom: 10px; right: 15px;
            font-family: 'Comic Sans MS', sans-serif; font-size: 0.9rem;
            color: rgba(255,255,255,0.3); font-weight: bold; pointer-events: none;
        }

    </style>
    <!-- Matter.js Fizik Motoru -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
</head>
<body>

    <div id="game-container">
        <canvas id="world"></canvas>

        <!-- Yeni √ñzel Bildirim Kutusu -->
        <div id="custom-notification"></div>

        <!-- Efektler -->
        <div id="panic-overlay"></div>
        <div id="panic-message"><span id="txt-panic-iq">0 IQ OYNAYI≈û</span><br><span style="font-size: 3rem;" id="txt-panic-ohno">EYVAH üò±</span></div>
        <div id="broke-message"><span id="txt-broke">PARASIZ EZƒ∞K!</span><br>üòÇ üí∏</div>
        <div id="dumb-message" style="font-size:3rem; color:red; border: 4px solid red; background:#000; padding:20px; border-radius:20px; font-weight:bold; color:white;">ARE U DUMB? üåä</div>
        <div id="level3-message">NOW IT'S GETTING HARDER... üòà</div>
        <div id="tutorial-text">D - ƒ∞LERƒ∞<br>A - GERƒ∞<br>SPACE - FREN</div>

        <!-- Oyun ƒ∞√ßi HUD -->
        <button id="btn-ingame-settings" onclick="toggleInGameSettings()">‚öôÔ∏è</button>
        
        <div id="pedals-container">
            <div id="brake-pedal" class="pedal brake">FREN<br><span style="font-size:0.8rem">(Space)</span></div>
            <div id="gas-pedal" class="pedal gas">GAZ<br><span style="font-size:0.8rem">(D)</span></div>
        </div>

        <div id="score-board">DIST: 0m</div>
        <div id="level-indicator">LEVEL 1</div>
        <div id="coin-counter">ü™ô <span id="coin-value">0</span></div>
        <div id="speedometer">
            <div id="boost-label">BOOST (SHIFT)</div>
            <div id="boost-bar-container"><div id="boost-bar"></div></div>
            <div id="speed-bar-container"><div id="speed-bar"></div></div>
            <div id="speed-value">0</div>
            <div id="speed-unit">km/h</div>
        </div>

        <!-- Ba≈ülangƒ±√ß Ekranƒ± -->
        <div id="start-screen" class="overlay">
            <div class="menu-content">
                <h1>BooomBob!</h1>
                <div class="subtitle">ULTIMATE EDITION</div>
                
                <button class="btn-start" style="margin-top: 20px;" onclick="startGame()" id="btn-start">OYNA</button>
                <button class="btn-settings" onclick="openScreen('settings')" id="btn-settings">AYARLAR ‚öôÔ∏è</button>
                
                <div class="menu-row">
                    <button class="btn-shop" onclick="openScreen('shop')" id="btn-shop">SHOP üõí</button>
                    <button class="btn-inventory" onclick="openScreen('inventory')" id="btn-inventory">√áANTA üéí</button>
                    <button class="btn-levels" onclick="openScreen('levels')" id="btn-levels">B√ñL√úMLER üó∫Ô∏è</button>
                </div>

                <div class="credits">Made by Belushka</div>
            </div>
        </div>

        <!-- Shop Ekranƒ± -->
        <div id="shop-screen" class="overlay" style="display:none;">
            <div class="shop-header" style="display:flex; justify-content:space-between; width:80%; align-items:center;">
                <h2 class="screen-title" id="title-shop">MAƒûAZA</h2>
                <div style="background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:15px; font-weight:bold; font-size:1.5rem; color:#FACC15;">
                    ü™ô <span id="shop-balance">0</span>
                </div>
            </div>
            <div class="scroll-area" id="shop-container">
                <!-- JS ile doldurulacak -->
            </div>
            <button class="btn-back" onclick="closeScreens()" id="btn-back1">GERƒ∞ D√ñN</button>
        </div>

        <!-- Inventory Ekranƒ± -->
        <div id="inventory-screen" class="overlay" style="display:none;">
            <h2 class="screen-title" style="color:#A78BFA;" id="title-inventory">ENVANTER</h2>
            <div class="scroll-area" id="inventory-container">
                <!-- JS ile doldurulacak -->
            </div>
            <button class="btn-back" onclick="closeScreens()" id="btn-back2">GERƒ∞ D√ñN</button>
        </div>

        <!-- Levels Ekranƒ± -->
        <div id="levels-screen" class="overlay" style="display:none;">
            <h2 class="screen-title" style="color:#FBBF24;" id="title-levels">B√ñL√úM SE√á</h2>
            <div class="scroll-area">
                <button class="level-btn" onclick="selectLevel(1)">
                    <span id="lvl-btn-1">LEVEL 1: BEBEK ADIMLARI</span>
                    <span class="level-info">140m</span>
                </button>
                <button class="level-btn" onclick="selectLevel(2)">
                    <span id="lvl-btn-2">LEVEL 2: Cƒ∞DDƒ∞LE≈ûƒ∞YOR</span>
                    <span class="level-info">100m</span>
                </button>
                <button class="level-btn" onclick="selectLevel(3)">
                    <span id="lvl-btn-3">LEVEL 3: ZOR MOD</span>
                    <span class="level-info">200m</span>
                </button>
                <button class="level-btn" onclick="selectLevel(4)">
                    <span id="lvl-btn-4">LEVEL 4: MOON JUMP</span>
                    <span class="level-info">240m</span>
                </button>
                <button class="level-btn" onclick="selectLevel(5)">
                    <span id="lvl-btn-5">LEVEL 5: OCEAN LEVEL</span>
                    <span class="level-info">???</span>
                </button>
            </div>
            <button class="btn-back" onclick="closeScreens()" id="btn-back3">GERƒ∞ D√ñN</button>
        </div>

        <div id="settings-screen" class="overlay" style="display:none;">
            <h2 class="screen-title" style="color:#9CA3AF;" id="title-settings">AYARLAR</h2>
            <div class="scroll-area">
                <div class="settings-section">
                    <span id="lbl-lang" style="font-weight:bold; color:#FACC15; display:block; margin-bottom:10px;">Dƒ∞L / LANGUAGE</span>
                    <div class="lang-container">
                        <button class="lang-btn active" onclick="setLanguage('tr')" id="btn-tr">T√úRK√áE</button>
                        <button class="lang-btn" onclick="setLanguage('en')" id="btn-en">ENGLISH</button>
                    </div>
                </div>
                <div class="settings-section" style="position:relative; text-align:center;">
                    <button class="btn-sugg" onclick="toggleSuggestions()" id="btn-toggle-sugg">√ñNERƒ∞ YAP üí°</button>
                    <div id="suggestions-box">
                        <textarea placeholder="..."></textarea>
                        <button class="btn-start" style="font-size:0.8rem; padding:0.3rem 0.8rem; margin-top:5px;" onclick="alert('G√∂nderildi! / Sent!')" id="btn-submit">G√ñNDER</button>
                    </div>
                </div>
                <div class="settings-section">
                     <button class="btn-bug" onclick="openBugReport()" id="btn-bug">BUG REPORT üêû</button>
                </div>
                <div class="settings-section">
                    <button class="btn-reset" style="background:black; border:1px solid red; color:red; font-size:0.8rem;" onclick="resetGameData()">VERƒ∞LERƒ∞ SIFIRLA ‚ö†Ô∏è</button>
                </div>
            </div>
            <button class="btn-back" onclick="closeScreens()" id="btn-back4">GERƒ∞ D√ñN</button>
        </div>

        <!-- Oyun ƒ∞√ßi Ayarlar Modalƒ± -->
        <div id="ingame-settings-screen" class="overlay" style="display:none; background-color: rgba(0,0,0,0.8);">
            <h2 style="color:white; margin-bottom:30px;">PAUSED</h2>
            <button class="btn-start" onclick="toggleInGameSettings()">DEVAM ET</button>
            <button class="btn-bug" style="font-size: 1.2rem; padding:0.8rem 2rem; margin-top: 20px;" onclick="openBugReport()">BUG REPORT üêû</button>
            <button class="btn-back" onclick="goToMenu()">ANA MEN√ú</button>
        </div>

        <div id="gameover-screen" class="overlay">
            <h2 id="title-gameover">√ñLD√úN</h2>
            <p style="font-size: 2rem; color: #E5E7EB; margin-bottom: 2rem; font-style: italic;" id="txt-skill">KOLSUZLUK...</p>
            <p style="font-size: 3rem; margin-bottom: 2rem; font-weight: bold; color: #FACC15;">Skor: <span id="final-score">0</span>m</p>
            <p style="font-size: 1.5rem; margin-bottom: 2rem; font-weight: bold; color: #FACC15;">Kazanƒ±lan: ü™ô <span id="final-coins">0</span></p>
            
            <button class="btn-start" onclick="startGame()" id="btn-retry">TEKRAR DENE</button>
            <button class="btn-shop" style="margin-top: 20px;" onclick="goToMenu()" id="btn-menu1">ANA MEN√ú</button>
        </div>

        <div id="win-screen" class="overlay">
            <h2 id="title-win">KAZANDIN!</h2>
            <p style="font-size: 2rem; color: #E5E7EB; margin-bottom: 2rem; font-style: italic;" id="txt-win-msg">FENA DEƒûƒ∞L..</p>
            <p style="font-size: 3rem; margin-bottom: 2rem; font-weight: bold; color: #FACC15;" id="win-level-text">LEVEL 1 TAMAMLANDI</p>
            <button class="btn-start" onclick="nextLevel()" id="btn-next">SONRAKƒ∞ LEVEL</button>
        </div>
    </div>

    <script>
        let GAME_WIDTH = window.innerWidth;
        let GAME_HEIGHT = window.innerHeight;
        window.addEventListener('resize', () => {
            GAME_WIDTH = window.innerWidth;
            GAME_HEIGHT = window.innerHeight;
            if(canvas) { canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT; }
        });

        // --- DATA Sƒ∞STEMƒ∞ ---
        let wallet = 0;
        try { wallet = parseInt(localStorage.getItem('boombob_wallet')) || 0; } catch(e){ wallet = 0; }
        
        let inventory = ['driver_default', 'car_default'];
        try { 
            const savedInv = JSON.parse(localStorage.getItem('boombob_inventory'));
            if(Array.isArray(savedInv)) inventory = savedInv;
        } catch(e) { console.log("Inv error reset"); }

        let equipped = { driver: 'driver_default', car: 'car_default', accessory: null };
        try {
            const savedEq = JSON.parse(localStorage.getItem('boombob_equipped'));
            if(savedEq) equipped = savedEq;
        } catch(e) { console.log("Eq error reset"); }
        
        // BOOST VARIABLES
        let canBoost = true;
        let isBoosting = false;
        let boostCooldownTimer = 0;
        let boostFuel = 100;
        let spawnInvincibility = false; 
        
        // --- LEVEL 4 ALIEN LOGIC ---
        let alienAlive = true;

        const SHOP_ITEMS = [
            { id: 'car_boat', type: 'car', name: 'Tekne', price: 600, icon: 'üö§' },
            { id: 'driver_zombie', type: 'driver', name: 'Zombi Bob', price: 5000, icon: 'üßü' },
            { id: 'driver_alien', type: 'driver', name: 'Uzaylƒ±', price: 10000, icon: 'üëΩ' },
            { id: 'car_blue', type: 'car', name: 'Mavi ≈ûim≈üek', price: 15000, icon: 'üöô' },
            { id: 'car_gold', type: 'car', name: 'Altƒ±n Kral', price: 50000, icon: 'üëë' },
            { id: 'acc_turbo', type: 'accessory', name: 'Turbo Motor', price: 20000, icon: 'üöÄ' }
        ];

        const DISPLAY_ITEMS_IDS = ['car_boat']; 

        function saveGameData() {
            localStorage.setItem('boombob_wallet', wallet);
            localStorage.setItem('boombob_inventory', JSON.stringify(inventory));
            localStorage.setItem('boombob_equipped', JSON.stringify(equipped));
        }

        function resetGameData() {
            if(confirm("T√ºm ilerlemen silinecek! Emin misin?")) {
                localStorage.removeItem('boombob_wallet');
                localStorage.removeItem('boombob_inventory');
                localStorage.removeItem('boombob_equipped');
                location.reload();
            }
        }

        // --- Dƒ∞L Sƒ∞STEMƒ∞ ---
        let currentLang = localStorage.getItem('boombob_lang') || 'tr';
        const TEXTS = {
            tr: {
                play: "OYNA", shop: "MAƒûAZA üõí", inventory: "√áANTA üéí", levels: "B√ñL√úMLER üó∫Ô∏è", settings: "AYARLAR ‚öôÔ∏è", back: "GERƒ∞ D√ñN",
                level1Name: "LEVEL 1: BEBEK ADIMLARI", level2Name: "LEVEL 2: Cƒ∞DDƒ∞LE≈ûƒ∞YOR", level3Name: "LEVEL 3: ZOR MOD", 
                level4Name: "LEVEL 4: AY ZIPLAMASI", level5Name: "LEVEL 5: OKYANUS",
                tutorial: "D-ƒ∞LERƒ∞  A-GERƒ∞  SPACE-FREN", level3Msg: "≈ûƒ∞MDƒ∞ ZORLA≈ûIYOR... üòà",
                winTitle: "KAZANDIN!", win1: "FENA DEƒûƒ∞L..", win2: "ƒ∞Yƒ∞ ƒ∞≈û!", win3: "EFSANEVƒ∞!",
                gameOver: "√ñLD√úN", skillIssue: "KOLSUZLUK...", tryAgain: "TEKRAR DENE", mainMenu: "ANA MEN√ú",
                shopTitle: "MAƒûAZA", inventoryTitle: "ENVANTER", levelsTitle: "B√ñL√úM SE√á", settingsTitle: "AYARLAR",
                langLabel: "Dƒ∞L / LANGUAGE", suggTitle: "√ñNERƒ∞ YAP üí°", submit: "G√ñNDER", empty: "√áantan bombo≈ü...",
                comingSoon: "GELECEK G√úNCELLEMEDE... üöß", shopDrivers: "S√úR√úC√úLER", shopCars: "ARABALAR", shopAccessories: "AKSESUARLAR",
                panic: "0 IQ OYNAYI≈û", ohno: "EYVAH üò±", broke: "PARASIZ EZƒ∞K!", next: "SONRAKƒ∞ LEVEL",
                finishGame: "T√ºm Leveller Bitti! Ba≈üa d√∂n√ºl√ºyor.", equip: "KU≈ûAN", equipped: "KU≈ûANDIN", buy: "SATIN AL",
                drownTitle: "BOƒûULDUN", drownMsg: "ARE U DUMB?",
                boatBan: "Tekneler karada gitmez kaptan! üö´<br>Varsayƒ±lan arabaya ge√ßiliyor."
            },
            en: {
                play: "PLAY", shop: "SHOP üõí", inventory: "INVENTORY üéí", levels: "LEVELS üó∫Ô∏è", settings: "SETTINGS ‚öôÔ∏è", back: "BACK",
                level1Name: "LEVEL 1: BABY STEPS", level2Name: "LEVEL 2: GETTING SERIOUS", level3Name: "LEVEL 3: GETTING HARDER",
                level4Name: "LEVEL 4: MOON JUMP", level5Name: "LEVEL 5: OCEAN",
                tutorial: "D-GAS  A-BACK  SPACE-BRAKE", level3Msg: "NOW IT'S GETTING HARDER... üòà",
                winTitle: "YOU WON!", win1: "NOT BAD..", win2: "GOOD JOB!", win3: "LEGENDARY!",
                gameOver: "YOU DIED", skillIssue: "(skill issue...)", tryAgain: "TRY AGAIN", mainMenu: "MAIN MENU",
                shopTitle: "SHOP", inventoryTitle: "INVENTORY", levelsTitle: "LEVEL SELECT", settingsTitle: "SETTINGS",
                langLabel: "LANGUAGE", suggTitle: "MAKE SUGGESTION üí°", submit: "SUBMIT", empty: "Inventory is empty...",
                comingSoon: "COMING SOON... üöß", shopDrivers: "DRIVERS", shopCars: "CARS", shopAccessories: "ACCESSORIES",
                panic: "0 IQ GAMEPLAY", ohno: "OH NOO üò±", broke: "HAHA BROKE LOSER!", next: "NEXT LEVEL",
                finishGame: "All Levels Completed! Returning to start.", equip: "EQUIP", equipped: "EQUIPPED", buy: "BUY",
                drownTitle: "DROWNED", drownMsg: "ARE U DUMB?",
                boatBan: "Boats don't go on land, captain! üö´<br>Switching to default car."
            }
        };

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('boombob_lang', lang);
            document.getElementById('btn-tr').classList.toggle('active', lang === 'tr');
            document.getElementById('btn-en').classList.toggle('active', lang === 'en');
            const t = TEXTS[lang];
            const ids = {
                'btn-start': t.play, 'btn-shop': t.shop, 'btn-inventory': t.inventory, 'btn-levels': t.levels, 'btn-settings': t.settings,
                'title-shop': t.shopTitle, 'title-inventory': t.inventoryTitle, 'title-levels': t.levelsTitle, 'title-settings': t.settingsTitle,
                'lvl-btn-1': t.level1Name + " - 140m", 'lvl-btn-2': t.level2Name + " - 100m", 'lvl-btn-3': t.level3Name + " - 200m",
                'lvl-btn-4': t.level4Name + " - 240m", 'lvl-btn-5': t.level5Name + " - 300m",
                'lbl-lang': t.langLabel, 'btn-toggle-sugg': t.suggTitle, 'btn-submit': t.submit,
                'btn-back1': t.back, 'btn-back2': t.back, 'btn-back3': t.back, 'btn-back4': t.back,
                'tutorial-text': t.tutorial, 'level3-message': t.level3Msg, 'txt-panic-iq': t.panic, 'txt-panic-ohno': t.ohno, 'broke-message': t.broke + "<br>üòÇ üí∏",
                'title-gameover': t.gameOver, 'txt-skill': t.skillIssue, 'btn-retry': t.tryAgain, 'btn-menu1': t.mainMenu,
                'title-win': t.winTitle, 'btn-next': t.next
            };
            for (const [id, text] of Object.entries(ids)) { const el = document.getElementById(id); if(el) el.innerHTML = text; }
            renderShop(); renderInventory();
        }

        function renderShop() {
            const container = document.getElementById('shop-container');
            container.innerHTML = '';
            const categories = ['driver', 'car', 'accessory'];
            const titles = { driver: TEXTS[currentLang].shopDrivers, car: TEXTS[currentLang].shopCars, accessory: TEXTS[currentLang].shopAccessories };

            categories.forEach(cat => {
                const titleDiv = document.createElement('div');
                titleDiv.className = 'shop-section-title';
                titleDiv.innerText = titles[cat];
                container.appendChild(titleDiv);

                const grid = document.createElement('div'); 
                grid.className = 'shop-grid';
                
                const itemsToShow = SHOP_ITEMS.filter(i => i.type === cat && DISPLAY_ITEMS_IDS.includes(i.id));
                
                if(itemsToShow.length === 0) {
                     const emptyMsg = document.createElement('div');
                     emptyMsg.className = 'coming-soon';
                     emptyMsg.innerText = TEXTS[currentLang].comingSoon;
                     container.appendChild(emptyMsg);
                } else {
                    itemsToShow.forEach(item => {
                        const isOwned = inventory.includes(item.id);
                        if(isOwned) return; 

                        const div = document.createElement('div'); 
                        div.className = `shop-item`;
                        div.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div><div class="item-price">ü™ô ${item.price}</div>`;
                        
                        div.addEventListener('click', () => buyItem(item));
                        
                        grid.appendChild(div);
                    });
                    container.appendChild(grid);
                }
            });
        }

        function buyItem(item) {
            if(wallet >= item.price) {
                wallet -= item.price; 
                inventory.push(item.id); 
                saveGameData();
                document.getElementById('shop-balance').innerText = wallet; 
                renderShop(); 
                renderInventory(); 
            } else {
                const brokeMsg = document.getElementById('broke-message'); 
                brokeMsg.classList.add('active');
                setTimeout(() => brokeMsg.classList.remove('active'), 2000);
            }
        }

        function renderInventory() {
            const container = document.getElementById('inventory-container'); container.innerHTML = '';
            if(inventory.length === 0) { container.innerHTML = `<p style="font-size: 2rem; color: #D1D5DB;">${TEXTS[currentLang].empty}</p><div style="font-size: 6rem;">üï∏Ô∏è</div>`; return; }
            const grid = document.createElement('div'); grid.className = 'shop-grid';
            
            const allItems = [ 
                { id: 'driver_default', type: 'driver', name: 'Bob', icon: 'üòê' }, 
                { id: 'car_default', type: 'car', name: 'Kƒ±rmƒ±zƒ±', icon: 'üöó' }, 
                ...SHOP_ITEMS.filter(i => inventory.includes(i.id)) 
            ];
            
            allItems.forEach(item => {
                const isEquipped = equipped[item.type] === item.id;
                const div = document.createElement('div'); 
                div.className = `shop-item ${isEquipped ? 'equipped' : ''}`;
                div.innerHTML = `<div class="item-icon">${item.icon}</div><div class="item-name">${item.name}</div><div class="item-status">${isEquipped ? TEXTS[currentLang].equipped : TEXTS[currentLang].equip}</div>`;
                div.onclick = () => equipItem(item);
                grid.appendChild(div);
            });
            container.appendChild(grid);
        }

        function equipItem(item) { equipped[item.type] = item.id; saveGameData(); renderInventory(); }

        let engine, car, driverHead;
        let coins = [], particles = [], fish = [], seagulls = [];
        let gameState = 'start', score = 0, level = 1;
        let animationFrameId, cloudOffset = 0;
        let camera = { x: 0, y: 0 };
        let tutorialState = { A: false, D: false, Space: false };
        let isPaused = false;

        const LEVEL_CONFIG = { 1: { targetDistance: 140 }, 2: { targetDistance: 100 }, 3: { targetDistance: 200 }, 4: { targetDistance: 240 }, 5: { targetDistance: 300 } };
        const keys = {};
        const carImg = new Image(); carImg.src = 'car.png';
        const boatImg = new Image(); boatImg.src = 'boat.png';
        const headImg = new Image(); headImg.src = 'head.png';
        const canvas = document.getElementById('world');
        const ctx = canvas.getContext('2d');
        canvas.width = GAME_WIDTH; canvas.height = GAME_HEIGHT;

        function createFloatingHeads() {
            const container = document.getElementById('start-screen');
            container.querySelectorAll('.floating-item').forEach(e => e.remove());
            container.querySelectorAll('.floating-heart').forEach(e => e.remove());
            for(let i=0; i<30; i++) {
                const img = document.createElement('img'); img.src = 'head.png'; img.className = 'floating-item';
                img.style.left = Math.random() * 100 + '%'; img.style.top = -(Math.random() * 50 + 10) + '%';
                img.style.width = (20+Math.random()*40)+'px'; 
                img.style.animationDuration = (5+Math.random()*10)+'s'; img.style.animationDelay = (Math.random()*5)+'s';
                container.appendChild(img);
            }
            for(let i=0; i<20; i++) {
                const div = document.createElement('div'); div.innerText = '‚ù§Ô∏è'; div.className = 'floating-heart';
                div.style.left = Math.random()*100+'%'; div.style.top = -(Math.random() * 50 + 10) + '%';
                div.style.animationDuration = (4+Math.random()*6)+'s'; div.style.animationDelay = (Math.random()*5)+'s';
                container.appendChild(div);
            }
        }

        window.onload = function() {
            setLanguage(currentLang); renderShop(); renderInventory(); createFloatingHeads(); 
        };

        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space') e.preventDefault();
            
            // FIX: Capture Shift key correctly
            if (e.key === 'Shift') keys['Shift'] = true;
            else keys[e.code] = true;
            
            if(gameState === 'playing' && !isPaused && level === 1) {
                if(e.code === 'KeyD') tutorialState.D = true; if(e.code === 'KeyA') tutorialState.A = true; if(e.code === 'Space') tutorialState.Space = true;
                if(tutorialState.A && tutorialState.D && tutorialState.Space) document.getElementById('tutorial-text').style.display = 'none';
            }
        });
        window.addEventListener('keyup', (e) => {
             // FIX: Capture Shift key correctly
            if (e.key === 'Shift') keys['Shift'] = false;
            else keys[e.code] = false;
        });

        function toggleSuggestions() { const box = document.getElementById('suggestions-box'); box.style.display = box.style.display === 'block' ? 'none' : 'block'; }
        function openScreen(name) {
            ['start','shop','inventory','levels','settings'].forEach(s => document.getElementById(s+'-screen').style.display = 'none');
            document.getElementById(name+'-screen').style.display = 'flex';
            if(name === 'shop') document.getElementById('shop-balance').innerText = wallet;
        }
        function closeScreens() {
            ['shop','inventory','levels','settings'].forEach(s => document.getElementById(s+'-screen').style.display = 'none');
            document.getElementById('start-screen').style.display = 'flex';
        }
        function selectLevel(l) { level = l; closeScreens(); startGame(); }
        function goToMenu() { gameState = 'start'; isPaused = false; if(animationFrameId) cancelAnimationFrame(animationFrameId); if(engine) { Matter.World.clear(engine.world); Matter.Engine.clear(engine); } ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT); ctx.fillStyle = '#93C5FD'; ctx.fillRect(0,0, GAME_WIDTH, GAME_HEIGHT); updateUI('start'); }
        function toggleInGameSettings() { isPaused = !isPaused; document.getElementById('ingame-settings-screen').style.display = isPaused ? 'flex' : 'none'; }
        function openBugReport() { alert("Bug Report: Hen√ºz sunucu baƒülantƒ±sƒ± yok ama ≈üikayetiniz not alƒ±ndƒ±! üìù"); }
        
        // --- YENƒ∞ Bƒ∞LDƒ∞Rƒ∞M Sƒ∞STEMƒ∞ ---
        function showNotification(msg) {
            const el = document.getElementById('custom-notification');
            el.innerHTML = msg;
            el.classList.add('active');
            setTimeout(() => {
                el.classList.remove('active');
            }, 3000);
        }

        function updateUI(state) {
            ['start-screen','shop-screen','inventory-screen','levels-screen','settings-screen','gameover-screen','win-screen','ingame-settings-screen'].forEach(id => { document.getElementById(id).style.display = 'none'; });
            ['score-board','level-indicator','coin-counter','speedometer','tutorial-text','btn-ingame-settings','pedals-container'].forEach(id => { document.getElementById(id).style.display = 'none'; });
            document.getElementById('panic-overlay').classList.remove('active'); document.getElementById('panic-message').classList.remove('active');
            document.getElementById('level3-message').classList.remove('active'); document.getElementById('broke-message').classList.remove('active');
            document.getElementById('dumb-message').classList.remove('active');

            if (state === 'start') { createFloatingHeads(); document.getElementById('start-screen').style.display = 'flex'; }
            else if (state === 'playing') {
                document.getElementById('score-board').style.display = 'block'; document.getElementById('level-indicator').style.display = 'block';
                document.getElementById('coin-counter').style.display = 'flex'; document.getElementById('speedometer').style.display = 'flex';
                
                // --- BOOST VISIBILITY CHECK ---
                if (equipped.car === 'car_boat') {
                    document.getElementById('boost-label').style.display = 'block';
                    document.getElementById('boost-bar-container').style.display = 'block';
                } else {
                    document.getElementById('boost-label').style.display = 'none';
                    document.getElementById('boost-bar-container').style.display = 'none';
                }
                // ------------------------------

                document.getElementById('btn-ingame-settings').style.display = 'block'; document.getElementById('pedals-container').style.display = 'flex';
                document.getElementById('coin-value').innerText = wallet;
                document.getElementById('level-indicator').innerText = TEXTS[currentLang]["level" + level + "Name"].split(':')[0];
                if (level === 1 && (!tutorialState.A || !tutorialState.D || !tutorialState.Space)) document.getElementById('tutorial-text').style.display = 'block';
                if (level === 3) { const l3m = document.getElementById('level3-message'); l3m.classList.add('active'); setTimeout(() => l3m.classList.remove('active'), 4000); }
                let bg = '#93C5FD'; if(level === 4) bg = '#1e1b4b'; if(level === 5) bg = '#60A5FA'; 
                document.getElementById('game-container').style.backgroundColor = bg;
            } else if (state === 'gameover') {
                document.getElementById('gameover-screen').style.display = 'flex'; document.getElementById('final-score').innerText = score; document.getElementById('final-coins').innerText = wallet;
            } else if (state === 'win') {
                document.getElementById('win-screen').style.display = 'flex'; const t = TEXTS[currentLang]; let msg = t.win1; if(level === 2) msg = t.win2; if(level >= 3) msg = t.win3;
                document.getElementById('txt-win-msg').innerText = msg; document.getElementById('win-level-text').innerText = (currentLang === 'tr' ? "LEVEL " + level + " TAMAMLANDI" : "LEVEL " + level + " COMPLETED");
            }
        }

        function startGame() { 
            if(gameState === 'playing') return;
            
            // TEKNE KONTROL√ú (UI Alert ile)
            if (level !== 5 && equipped.car === 'car_boat') {
                showNotification(TEXTS[currentLang].boatBan);
                equipped.car = 'car_default';
                saveGameData(); 
                renderInventory();
            }

            gameState = 'playing'; isPaused = false; score = 0; coins = []; particles = []; 
            tutorialState = { A: false, D: false, Space: false }; camera = { x: 0, y: 0 }; 
            boostFuel = 100; 
            spawnInvincibility = false; 
            alienAlive = true; // Level 4 reset

            // --- LEVEL 5 START ANIMATION SETUP ---
            if (level === 5) {
                spawnInvincibility = true; // ƒ∞lk d√º≈ü√º≈üte √∂lmemesi i√ßin
                setTimeout(() => { spawnInvincibility = false; }, 2000); // 2 saniye koruma
            }
            // -------------------------------------

            document.getElementById('score-board').innerText = `DIST: 0m`; 
            updateUI('playing'); 
            if (animationFrameId) cancelAnimationFrame(animationFrameId); 
            setupPhysicsWorld(); 
            gameLoop(); 
        }
        function nextLevel() { if (LEVEL_CONFIG[level + 1]) { level++; gameState = 'start'; startGame(); } else { alert(TEXTS[currentLang].finishGame); level = 1; gameState = 'start'; updateUI('start'); } }

        function setupPhysicsWorld() {
            const Engine = Matter.Engine, World = Matter.World, Bodies = Matter.Bodies, Composite = Matter.Composite, Constraint = Matter.Constraint, Events = Matter.Events;
            if (engine) { Matter.World.clear(engine.world); Matter.Engine.clear(engine); } else { engine = Engine.create(); }
            engine.positionIterations = 8; engine.velocityIterations = 8; engine.gravity.y = (level === 4) ? 0.5 : 1.5;
            const world = engine.world;

            const CAT_CAR = 0x0002, CAT_GROUND = 0x0004, CAT_DRIVER = 0x0008, CAT_COIN = 0x0010, CAT_FINISH = 0x0020;
            const config = LEVEL_CONFIG[level] || LEVEL_CONFIG[1];

            const startWall = Bodies.rectangle(-200, 0, 200, 20000, { isStatic: true, render: { visible: false } }); Composite.add(world, startWall);

            const terrainBodies = []; let x = 0; let y = GAME_HEIGHT * 0.7; const segmentWidth = 60; const maxSegments = 800;
            for (let i = 0; i < maxSegments; i++) {
                let change = 0;
                if (i > 10) {
                    if (level === 1) { change = Math.sin(i * 0.05) * 20 + Math.sin(i * 0.1) * 20; }
                    else if (level === 2) { change = Math.sin(i * 0.1) * 30 + Math.sin(i * 0.2) * 40; if (i % 50 > 40) change -= 50; }
                    else if (level === 3) { change = Math.sin(i * 0.15) * 40 + Math.sin(i * 0.25) * 20; if (i % 40 > 30) change += 40; if (i % 60 > 50) change -= 30; }
                    else if (level === 4) { if(i % 15 > 10) { x += segmentWidth; continue; } change = Math.sin(i * 0.1) * 30; }
                    
                    // --- LEVEL 5 HARDER WAVES ---
                    else if (level === 5) { change = Math.sin(i * 0.15) * 30; } // Increased wave height
                    // ----------------------------
                }
                const nextY = (GAME_HEIGHT * 0.7) + change; const angle = Math.atan2(nextY - y, segmentWidth);
                
                const isWater = level === 5; const isBoat = equipped.car === 'car_boat';
                const groundOptions = { isStatic: true, friction: 0.8, angle: angle, label: 'ground', collisionFilter: { category: CAT_GROUND } };
                if (isWater) {
                     groundOptions.isSensor = true; 
                }
                
                const ground = Bodies.rectangle(x + segmentWidth / 2, (y + nextY) / 2 + 300, segmentWidth + 80, 600, groundOptions);
                terrainBodies.push(ground);
                
                // --- COIN LOGIC (FIXED) ---
                if (i > 10 && i % 6 === 0 && Math.random() > 0.3) {
                    let coinY = (y + nextY) / 2 - 50;
                    if (level === 5) coinY += 150; 

                    const coinX = x + segmentWidth / 2;
                    
                    // Coin Value Logic: 5 normally, 10 on harder/rare spots
                    const isHardSpot = (i % 12 === 0);
                    const coinValue = isHardSpot ? 10 : 5;
                    const coinRadius = isHardSpot ? 18 : 14;

                    const coin = Bodies.circle(coinX, coinY, coinRadius, { 
                        isStatic: true, 
                        isSensor: true, 
                        label: 'coin', 
                        coinValue: coinValue, 
                        isCollected: false, // Double collection prevention
                        collisionFilter: { category: CAT_COIN } 
                    });
                    coins.push(coin); Composite.add(world, coin);
                }
                // --------------------------

                x += segmentWidth; y = nextY;
            }
            Composite.add(world, terrainBodies);

            const finishX = config.targetDistance * 100;
            const finishLine = Bodies.rectangle(finishX, 200, 50, 5000, { isStatic: true, isSensor: true, label: 'finish', collisionFilter: { category: CAT_FINISH } });
            Composite.add(world, finishLine);

            // --- SPAWN LOGIC UPDATE ---
            let startX = 200; 
            let startY = GAME_HEIGHT * 0.5;
            
            // Level 5: Spawn on water surface, further back to simulate "sailing in"
            if (level === 5) {
                startX = -150; 
                startY = GAME_HEIGHT * 0.7; 
            }
            // --------------------------

            const chassis = Bodies.rectangle(startX, startY, 130, 40, { density: 0.004, friction: 0.5, label: 'chassis', collisionFilter: { group: -1, category: CAT_CAR, mask: CAT_GROUND | CAT_COIN | CAT_FINISH } });
            const wheelRadius = 18; 
            const wheelOptions = { density: 0.05, friction: 3.0, restitution: 0.0, frictionStatic: 10, label: 'wheel', collisionFilter: { group: -1, category: CAT_CAR, mask: CAT_GROUND | CAT_COIN | CAT_FINISH } };
            const wheelOffset = 35; 
            
            const isBoat = equipped.car === 'car_boat';
            let wheelBack, wheelFront, shockBack, shockFront;

            if (!isBoat) {
                wheelBack = Bodies.circle(startX - wheelOffset, startY + 30, wheelRadius, wheelOptions);
                wheelFront = Bodies.circle(startX + wheelOffset, startY + 30, wheelRadius, wheelOptions);
                const suspensionOptions = { bodyA: chassis, stiffness: 0.08, damping: 0.5, length: 0 };
                shockBack = Constraint.create({ ...suspensionOptions, bodyB: wheelBack, pointA: { x: -wheelOffset, y: 30 } });
                shockFront = Constraint.create({ ...suspensionOptions, bodyB: wheelFront, pointA: { x: wheelOffset, y: 30 } });
            }

            // --- HEAD ADJUSTMENT FOR BOAT ---
            // Teknede kafa daha yukarƒ±da olsun ki hemen suya deƒümesin
            let headOffsetY = -50;
            if(isBoat) headOffsetY = -70; // Raise head for boat

            const headBody = Bodies.circle(startX, startY + headOffsetY, 20, { density: 0.001, friction: 0.1, restitution: 0.2, label: 'driverHead', collisionFilter: { category: CAT_DRIVER, mask: CAT_GROUND } });
            
            // Neck adjustments
            const neck = Constraint.create({ 
                bodyA: chassis, 
                bodyB: headBody, 
                pointA: { x: -15, y: isBoat ? -45 : -25 }, // Higher anchor on boat chassis
                stiffness: 0.2, 
                damping: 0.1, 
                length: 2 
            });
            
            Composite.add(world, [chassis, headBody, neck]); 
            if (!isBoat) Composite.add(world, [wheelBack, wheelFront, shockBack, shockFront]); 

            car = { chassis, wheelBack, wheelFront }; driverHead = headBody;
            
            // --- LEVEL 5 INITIAL PUSH ---
            if (level === 5) {
                Matter.Body.setVelocity(chassis, { x: 8, y: 0 }); // Sahneye giri≈ü yapsƒ±n
            }

            Events.on(engine, 'collisionStart', (event) => {
                const pairs = event.pairs;
                for (let i = 0; i < pairs.length; i++) {
                    const { bodyA, bodyB } = pairs[i];
                    const labels = [bodyA.label, bodyB.label];
                    
                    // --- GAME OVER LOGIC (HEAD TOUCH) ---
                    if (labels.includes('driverHead') && labels.includes('ground')) { 
                        // SADECE TEKNE TERS D√ñND√úYSE √ñLD√úR
                        if (level === 5 && isBoat) {
                             // A√ßƒ± kontrol√º: Eƒüer tekne √ßok yatƒ±ksa (yakla≈üƒ±k 90 derece) √∂ld√ºr
                             // 1.5 radyan ~= 85 derece
                             if (Math.abs(chassis.angle) > 1.4 && !spawnInvincibility) {
                                 gameState = 'gameover'; 
                                 updateUI('gameover');
                             }
                        } 
                        // Dƒ∞ƒûER LEVELLERDE KAFA DEƒûERSE √ñL
                        else if (level !== 5) {
                             gameState = 'gameover'; 
                             updateUI('gameover');
                        }
                    }
                    // ------------------------------------

                    // --- COIN COLLECTION FIX ---
                    if ( (bodyA.label === 'coin' && (bodyB.label === 'chassis' || bodyB.label === 'wheel')) || (bodyB.label === 'coin' && (bodyA.label === 'chassis' || bodyA.label === 'wheel')) ) {
                        const coinBody = bodyA.label === 'coin' ? bodyA : bodyB;
                        
                        // Zaten toplandƒ± mƒ± kontrol et
                        if (!coinBody.isCollected) {
                            coinBody.isCollected = true; // ƒ∞≈üaretle
                            Matter.Composite.remove(engine.world, coinBody);
                            wallet += (coinBody.coinValue || 1); 
                            document.getElementById('coin-value').innerText = wallet; 
                            localStorage.setItem('boombob_wallet', wallet);
                        }
                    }
                    // ---------------------------

                    if ( (bodyA.label === 'finish' && bodyB.label === 'chassis') || (bodyB.label === 'finish' && bodyA.label === 'chassis') ) { gameState = 'win'; updateUI('win'); }
                }
            });
        }

        function gameLoop() {
            if (gameState === 'playing' && !isPaused) {
                Matter.Engine.update(engine, 1000 / 60);
                
                // Level 5 Death Logic (Drowning Car)
                if (level === 5 && equipped.car !== 'car_boat' && car.chassis.position.y > GAME_HEIGHT + 100) {
                    document.getElementById('dumb-message').classList.add('active');
                    setTimeout(() => { 
                        gameState = 'gameover'; 
                        updateUI('gameover'); 
                        document.getElementById('title-gameover').innerText = TEXTS[currentLang].drownTitle;
                        document.getElementById('txt-skill').innerText = TEXTS[currentLang].drownMsg;
                    }, 1500);
                } else if (car && car.chassis.position.y > GAME_HEIGHT + 800) {
                    Matter.Body.setPosition(car.chassis, { x: 200, y: GAME_HEIGHT * 0.5 }); 
                    if(equipped.car !== 'car_boat') {
                        Matter.Body.setPosition(car.wheelBack, { x: 200 - 40, y: GAME_HEIGHT * 0.5 + 30 }); 
                        Matter.Body.setPosition(car.wheelFront, { x: 200 + 40, y: GAME_HEIGHT * 0.5 + 30 }); 
                    }
                    Matter.Body.setVelocity(car.chassis, { x: 0, y: 0 }); 
                    Matter.Body.setAngularVelocity(car.chassis, 0);
                }
                
                // Level 5 Buoyancy (Boat Only)
                if (level === 5 && equipped.car === 'car_boat') {
                    const waterLevel = (GAME_HEIGHT * 0.7) + Math.sin((car.chassis.position.x / 60) * 0.1) * 30; // Matches new wave height
                    if (car.chassis.position.y > waterLevel) {
                        const depth = car.chassis.position.y - waterLevel;
                        Matter.Body.applyForce(car.chassis, car.chassis.position, { x: 0, y: -0.008 * depth });
                        Matter.Body.setVelocity(car.chassis, { x: car.chassis.velocity.x * 0.95, y: car.chassis.velocity.y * 0.9 });
                        Matter.Body.setAngularVelocity(car.chassis, car.chassis.angularVelocity * 0.9);
                    }
                }
                
                // --- LEVEL 4 ALIEN ENCOUNTER LOGIC ---
                if (level === 4 && alienAlive) {
                    // Alien X coordinate: approx 200m (20000px)
                    const alienX = 20000;
                    const distToAlien = Math.abs(car.chassis.position.x - alienX);
                    // 2cm ~ 400px logic in game scale
                    if (distToAlien < 400) {
                        alienAlive = false; // Disappear
                        // Maybe play a sound here if we had audio
                    }
                }
                // -------------------------------------

                let MAX_SPEED = 0.5; if(level === 5 && equipped.car === 'car_boat') MAX_SPEED = 0.85;

                if (car && car.chassis) { camera.x = -car.chassis.position.x + GAME_WIDTH * 0.3; camera.y = -car.chassis.position.y + GAME_HEIGHT * 0.6; }
                
                let speedRaw = 0;
                if(equipped.car !== 'car_boat') speedRaw = Math.abs(car.wheelBack.angularVelocity);
                else speedRaw = Math.abs(car.chassis.velocity.x) * 0.1;

                let displayMax = 30; if(level === 5 && equipped.car === 'car_boat') displayMax = 50;
                const displaySpeed = Math.min(Math.round(speedRaw * 60), displayMax);
                document.getElementById('speed-value').innerText = displaySpeed; document.getElementById('speed-bar').style.width = Math.min((displaySpeed / displayMax) * 100, 100) + '%';

                // --- BOOST LOGIC (ONLY FOR BOAT) ---
                if (equipped.car === 'car_boat') {
                    if (keys['Shift'] && canBoost && boostFuel > 0) {
                        isBoosting = true;
                        boostFuel = Math.max(0, boostFuel - (100/300)); 
                    } else {
                        isBoosting = false;
                    }

                    if (boostFuel <= 0 && canBoost) {
                        canBoost = false; 
                        boostCooldownTimer = 300; 
                    }

                    if (!canBoost) {
                        boostCooldownTimer--;
                        let pct = 100 - (boostCooldownTimer / 300 * 100);
                        document.getElementById('boost-bar').style.width = pct + '%';
                        document.getElementById('boost-label').innerText = "SOƒûUTULUYOR... " + Math.floor(pct) + "%";

                        if (boostCooldownTimer <= 0) {
                            canBoost = true;
                            boostFuel = 100;
                            document.getElementById('boost-label').innerText = "BOOST (SHIFT)";
                        }
                    }
                    // Bar Width Update
                    const boostBar = document.getElementById('boost-bar');
                    if(canBoost) boostBar.style.width = boostFuel + '%';
                    if (!canBoost) boostBar.style.backgroundColor = '#EF4444'; 
                    else boostBar.style.backgroundColor = '#FACC15'; 
                }
                // -----------------------------------

                const gasPedal = document.getElementById('gas-pedal'); const brakePedal = document.getElementById('brake-pedal');
                if (keys['KeyD']) gasPedal.classList.add('pressed'); else gasPedal.classList.remove('pressed');
                if (keys['Space']) brakePedal.classList.add('pressed'); else brakePedal.classList.remove('pressed');

                if (equipped.car !== 'car_boat') {
                    if (keys['KeyD'] && car.wheelBack.angularVelocity < MAX_SPEED) { const acc = 0.015; Matter.Body.setAngularVelocity(car.wheelBack, car.wheelBack.angularVelocity + acc); Matter.Body.setAngularVelocity(car.wheelFront, car.wheelFront.angularVelocity + acc); }
                    if (keys['KeyA'] && car.wheelBack.angularVelocity > -MAX_SPEED) { const acc = 0.015; Matter.Body.setAngularVelocity(car.wheelBack, car.wheelBack.angularVelocity - acc); Matter.Body.setAngularVelocity(car.wheelFront, car.wheelFront.angularVelocity - acc); }
                    if (keys['Space']) {
                        Matter.Body.setAngularVelocity(car.wheelBack, car.wheelBack.angularVelocity * 0.9);
                        Matter.Body.setAngularVelocity(car.wheelFront, car.wheelFront.angularVelocity * 0.9);
                        if(Math.abs(car.wheelBack.angularVelocity) > 0.2) Matter.Body.setAngularVelocity(car.chassis, car.chassis.angularVelocity + 0.04);
                    }
                } else { // TEKNE KONTROL√ú
                     if (keys['KeyD']) Matter.Body.applyForce(car.chassis, car.chassis.position, { x: 0.03, y: 0 }); // DAHA HIZLI (0.03)
                     if (keys['KeyA']) Matter.Body.applyForce(car.chassis, car.chassis.position, { x: -0.01, y: 0 });
                     
                     // BOOST (Only works if boat is equipped and boosting)
                     if (isBoosting) {
                         Matter.Body.applyForce(car.chassis, car.chassis.position, { x: 0.05, y: 0 }); 
                     }
                }
                
                if (keys['KeyW'] && equipped.car !== 'car_boat') { 
                    Matter.Body.setAngularVelocity(car.chassis, car.chassis.angularVelocity - 0.05); 
                }

                // Particles
                if (equipped.car !== 'car_boat' && Math.abs(car.wheelBack.angularVelocity) > 0.1) {
                    const dirtX = car.wheelBack.position.x - Math.cos(car.chassis.angle) * 15; const dirtY = car.wheelBack.position.y + 15;
                    if(Math.random() > 0.5) particles.push({ x: dirtX, y: dirtY, vx: (Math.random() - 0.5) * 4 - 2, vy: -Math.random() * 3 - 1, life: 1.0, type: 'dirt' });
                }
                if (Math.abs(car.chassis.velocity.x) > 1) {
                     const smokeX = car.chassis.position.x - Math.cos(car.chassis.angle) * 60; const smokeY = car.chassis.position.y - Math.sin(car.chassis.angle) * 20;
                    if(Math.random() > 0.7) particles.push({ x: smokeX, y: smokeY, vx: -2 - Math.random(), vy: -1 + Math.random(), life: 1.0, type: 'smoke' });
                }

                for (let i = particles.length - 1; i >= 0; i--) { let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life -= 0.03; if (p.life <= 0) particles.splice(i, 1); }
                const dist = Math.floor(car.chassis.position.x / 100); if (dist > score) { score = dist; document.getElementById('score-board').innerText = `DIST: ${score}m`; }
            }
            draw();
            if (gameState !== 'stop') animationFrameId = requestAnimationFrame(gameLoop);
        }

        function draw() {
            ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT); ctx.save();
            ctx.translate(camera.x, camera.y);
            ctx.fillStyle = level === 5 ? '#3b82f6' : (level === 4 ? '#1e1b4b' : '#87CEEB');
            ctx.fillRect(-camera.x - 100, -camera.y - 100, GAME_WIDTH + 200, GAME_HEIGHT + 200);
            if (gameState === 'playing' && !isPaused) cloudOffset += 0.5; drawClouds(ctx, -camera.x * 0.5 - cloudOffset, -camera.y * 0.1); 
            
            // --- LEVEL 5 FISH (LOWERED) & LEVEL 4 UFOS ---
            const time = Date.now() / 1000;
            
            if(level === 5) { 
                // Ku≈ülar
                for(let i=0; i<5; i++) { 
                    const ux = -camera.x + (i * 300 + time * 50) % (GAME_WIDTH + 200); 
                    const uy = -camera.y + 100 + Math.sin(time + i) * 50; 
                    ctx.font = "40px Arial"; ctx.fillText("üê¶", ux, uy); 
                } 
                // Balƒ±klar (SUYUN ƒ∞√áƒ∞NDE - GEMƒ∞Nƒ∞N ALTINDA)
                // Y√ºkseklik 500 civarƒ±na √ßekildi
                for(let i=0; i<15; i++) { 
                    let speed = (time * 100) + (i * 50);
                    let fx = -camera.x + ((i * 300 - speed) % (GAME_WIDTH + 1000));
                    if(fx < -100) fx += (GAME_WIDTH + 1000); 
                    let fy = -camera.y + 550 + (i * 40) + Math.sin(time * 2 + i) * 30; 
                    
                    ctx.font = (20 + (i%3)*5) + "px Arial";
                    ctx.fillText("üêü", fx, fy); 
                } 
            }
            else if (level === 4) {
                 // UFOs (Flying in the sky)
                for(let i=0; i<5; i++) { 
                    const ux = -camera.x + (i * 400 + time * 80) % (GAME_WIDTH + 400); 
                    const uy = -camera.y + 50 + Math.sin(time * 2 + i) * 30; 
                    ctx.font = "50px Arial"; ctx.fillText("üõ∏", ux, uy); 
                }
            }
            // ---------------------------------------------

            if (engine) {
                const bodies = Matter.Composite.allBodies(engine.world);
                const config = LEVEL_CONFIG[level] || LEVEL_CONFIG[1];
                const finishX = config.targetDistance * 100;
                
                ctx.save(); ctx.translate(finishX, 400); 
                for(let i=0; i<10; i++) { ctx.fillStyle = i%2===0 ? '#FFFFFF' : '#000000'; ctx.fillRect(-10, 0, 40, 20); }
                ctx.fillStyle = '#C0C0C0'; ctx.fillRect(20, -200, 5, 200);
                ctx.fillStyle = level === 3 ? '#FFD700' : (level === 2 ? '#3B82F6' : '#EF4444');
                ctx.beginPath(); ctx.moveTo(25, -200); ctx.lineTo(80, -180); ctx.lineTo(25, -160); ctx.fill();
                for(let r=0; r<2; r++) for(let c=0; c<3; c++) { ctx.fillStyle = (r+c)%2===0?'black':'white'; ctx.fillRect(25+c*10, -160+r*10, 10, 10); }
                ctx.fillStyle = "#FACC15"; ctx.font = "bold 30px sans-serif"; ctx.fillText("FINISH", 0, -220); ctx.restore();

                // --- LEVEL 4 ALIEN RENDER & GLITCH ---
                if (level === 4 && alienAlive) {
                    const alienX = 20000;
                    const alienY = 300; // Standing on ground roughly
                    
                    // Draw Alien
                    ctx.save();
                    ctx.translate(alienX, alienY);
                    ctx.font = "100px Arial";
                    ctx.fillText("üëΩ", 0, 0);
                    ctx.restore();

                    // CHECK IF ALIEN IS ON SCREEN FOR GLITCH
                    const screenAlienX = alienX + camera.x;
                    if (screenAlienX > -100 && screenAlienX < GAME_WIDTH + 100) {
                        // Apply Glitch Effect (Slenderman style)
                        ctx.save();
                        // 1. Grayscale look
                        ctx.globalCompositeOperation = 'saturation';
                        ctx.fillStyle = "hsl(0,0%,50%)";
                        ctx.fillRect(-camera.x, -camera.y, GAME_WIDTH*2, GAME_HEIGHT*2);
                        ctx.globalCompositeOperation = 'source-over';
                        
                        // 2. Static Noise Bars
                        for(let i=0; i<20; i++) {
                            const barH = Math.random() * 50;
                            const barY = -camera.y + Math.random() * GAME_HEIGHT;
                            ctx.fillStyle = Math.random() > 0.5 ? 'rgba(0,0,0,0.5)' : 'rgba(255,255,255,0.3)';
                            ctx.fillRect(-camera.x - 100, barY, GAME_WIDTH + 200, barH);
                        }
                        
                        // 3. Screen Shake (Camera offset simulation)
                        const shakeX = (Math.random() - 0.5) * 20;
                        const shakeY = (Math.random() - 0.5) * 20;
                        ctx.translate(shakeX, shakeY);
                        
                        ctx.restore();
                    }
                }
                // -------------------------------------

                bodies.forEach(body => {
                    if (body.label === 'ground') {
                        ctx.save(); ctx.translate(body.position.x, body.position.y); ctx.rotate(body.angle);
                        if(level === 5) {
                            ctx.fillStyle = 'rgba(60, 160, 255, 0.6)'; ctx.beginPath(); ctx.rect(-70, -300, 140, 600); ctx.fill();
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)'; ctx.beginPath(); ctx.rect(-70, -300, 140, 10); ctx.fill();
                            
                            // Extra Waves Visuals
                            ctx.beginPath();
                            ctx.moveTo(-70, -300);
                            for(let i=0; i<=140; i+=10) {
                                ctx.lineTo(-70+i, -300 + Math.sin((Date.now()/200) + i*0.1)*5);
                            }
                            ctx.lineTo(70, 600);
                            ctx.lineTo(-70, 600);
                            ctx.fill();
                        } else {
                            ctx.beginPath(); ctx.rect(-70, -300, 140, 600); ctx.fillStyle = level === 5 ? '#1d4ed8' : '#5D4037'; ctx.fill();
                            ctx.beginPath(); ctx.rect(-70, -300, 140, 20); ctx.fillStyle = level === 5 ? '#60a5fa' : (level === 4 ? '#94a3b8' : '#4CAF50'); ctx.fill();
                            ctx.beginPath(); ctx.moveTo(-70, -300); ctx.lineTo(70, -300); ctx.strokeStyle = 'rgba(0,0,0,0.3)'; ctx.lineWidth = 3; ctx.stroke(); 
                        }
                        ctx.restore();
                    } else if (body.label === 'coin') {
                        ctx.save(); ctx.translate(body.position.x, body.position.y);
                        const value = body.coinValue || 1; const time = Date.now() / 200; const scaleX = Math.sin(time); 
                        ctx.scale(scaleX, 1); ctx.beginPath(); const radius = value === 10 ? 18 : 14; ctx.arc(0, 0, radius, 0, Math.PI * 2);
                        if (value === 10) { ctx.fillStyle = '#FFD700'; ctx.strokeStyle = '#B8860B'; } else { ctx.fillStyle = '#C0C0C0'; ctx.strokeStyle = '#808080'; }
                        ctx.fill(); ctx.lineWidth = 2; ctx.stroke();
                        ctx.fillStyle = value === 10 ? '#B8860B' : '#696969'; ctx.font = "bold 16px sans-serif"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText(value, 0, 1); ctx.restore();
                    }
                });

                particles.forEach(p => {
                    ctx.save(); ctx.globalAlpha = p.life;
                    if(p.type === 'dirt') { ctx.fillStyle = '#5D4037'; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill(); } 
                    else { ctx.fillStyle = '#9CA3AF'; ctx.beginPath(); ctx.arc(p.x, p.y, 6 + (1-p.life)*5, 0, Math.PI*2); ctx.fill(); } ctx.restore();
                });

                if (car && car.chassis) {
                    const wheelRad = 18;
                    if(equipped.car !== 'car_boat') { 
                         [car.wheelBack, car.wheelFront].forEach(wheel => {
                            ctx.save(); ctx.translate(wheel.position.x, wheel.position.y); ctx.rotate(wheel.angle);
                            ctx.beginPath(); ctx.arc(0,0,wheelRad,0,Math.PI*2); ctx.fillStyle='#111'; ctx.fill(); ctx.strokeStyle='#888'; ctx.lineWidth=3;
                            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(wheelRad,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,wheelRad); ctx.stroke();
                            ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-wheelRad,0); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(0,-wheelRad); ctx.stroke(); ctx.restore();
                        });
                    }

                    ctx.save(); ctx.translate(car.chassis.position.x, car.chassis.position.y); ctx.rotate(car.chassis.angle);
                    if(equipped.car === 'car_blue') ctx.filter = 'hue-rotate(200deg)'; else if(equipped.car === 'car_gold') ctx.filter = 'hue-rotate(45deg) brightness(1.5)';
                    
                    const drawImg = equipped.car === 'car_boat' ? boatImg : carImg;
                    if (drawImg.complete && drawImg.naturalWidth !== 0) { ctx.drawImage(drawImg, -65, -30, 130, 60); } else { ctx.fillStyle='red'; ctx.fillRect(-65,-20,130,40); } 
                    ctx.restore(); 

                    if (driverHead) {
                        ctx.save(); ctx.translate(driverHead.position.x, driverHead.position.y); ctx.rotate(car.chassis.angle); 
                        if(equipped.driver === 'driver_zombie') ctx.filter = 'hue-rotate(90deg)'; else if(equipped.driver === 'driver_alien') ctx.filter = 'hue-rotate(270deg)';
                        if (headImg.complete && headImg.naturalWidth !== 0) {
                            ctx.drawImage(headImg, -25, -25, 50, 50); ctx.filter = 'none';
                            let angle = car.chassis.angle % (Math.PI * 2); if (angle > Math.PI) angle -= Math.PI * 2; if (angle < -Math.PI) angle += Math.PI * 2;
                            
                            // --- PANIC MODE FOR ALL VEHICLES ---
                            // 1.0 Radyan yakla≈üƒ±k 60 derece eƒüim
                            if (Math.abs(angle) > 1.0) { 
                                document.getElementById('panic-overlay').classList.add('active'); 
                                document.getElementById('panic-message').classList.add('active');
                                [8, 22].forEach(xOff => { ctx.beginPath(); ctx.arc(xOff, -5, xOff === 22 ? 10 : 8, 0, Math.PI * 2); ctx.fillStyle = 'white'; ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.arc(xOff, -5, 3, 0, Math.PI * 2); ctx.fillStyle = 'black'; ctx.fill(); });
                            } else { 
                                document.getElementById('panic-overlay').classList.remove('active'); 
                                document.getElementById('panic-message').classList.remove('active'); 
                            }
                        } else { ctx.fillStyle='#FFCC80'; ctx.beginPath(); ctx.arc(0,0,20,0,Math.PI*2); ctx.fill(); } ctx.restore();
                    }
                }
            }
            ctx.restore();
        }

        function drawClouds(ctx, startX, startY) {
            ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
            for (let i = 0; i < 20; i++) {
                const cx = startX + i * 400;
                if (cx > -200 && cx < GAME_WIDTH + 200) {
                    const cy = startY + (i % 3) * 50;
                    ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI * 2); ctx.arc(cx + 30, cy - 10, 50, 0, Math.PI * 2); ctx.arc(cx + 70, cy, 40, 0, Math.PI * 2); ctx.fill();
                }
            }
        }

        setLanguage(currentLang); renderShop(); renderInventory();
    </script>
</body>
</html>